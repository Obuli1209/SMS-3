<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Admin Dashboard</title>
    <!-- <link rel="icon" href="/img/kaiadmin/favicon.ico" type="image/x-icon"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/kaiadmin.min.css">
    <!-- <link rel="stylesheet" href="/css/bootstrap.min.css"> -->
    <!-- <link rel="stylesheet" href="/css/plugins.min.css"> -->
    <!-- <link rel="stylesheet" href="/css/demo.css"> -->
    <style>
        .shift-btn {
            min-width: 90px;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
        }

        .shift-btn.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
    </style>
    <script src="/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: { families: ["Public Sans:300,400,500,600,700"] },
            custom: {
                families: [
                    "Font Awesome 5 Solid",
                    "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands",
                    "simple-line-icons",
                ],
                urls: ["/css/fonts.min.css"],
            },
            active: function () {
                sessionStorage.fonts = true;
            },
        });
    </script>
</head>

<body style="background-color: rgb(197, 197, 197);">
    <div class="wrapper">
        <div class="sidebar" data-background-color="dark">
            <div class="sidebar-logo">
                <div class="logo-header" data-background-color="dark">
                    <h4 style="color: white; padding-left: 10px;">SMS</h4>
                    <div class="nav-toggle">
                        <button class="btn btn-toggle toggle-sidebar">
                            <i class="gg-menu-right"></i>
                        </button>
                        <button class="btn btn-toggle sidenav-toggler">
                            <i class="gg-menu-left"></i>
                        </button>
                    </div>
                    <button class="topbar-toggler more">
                        <i class="gg-more-vertical-alt"></i>
                    </button>
                </div>
            </div>
            <div class="sidebar-wrapper scrollbar scrollbar-inner">
                <div class="sidebar-content">
                    <ul class="nav nav-secondary">
                        <li class="nav-item">
                            <a href="/index" class="nav-link">
                                <i class="fas fa-home"></i>
                                <p>Dashboard</p>
                            </a>
                        </li>
                        <li class="nav-section">
                            <span class="sidebar-mini-icon">
                                <i class="fa fa-ellipsis-h"></i>
                            </span>
                            <h4 class="text-section">Components</h4>
                        </li>
                        <li class="nav-item">
                            <a data-bs-toggle="collapse" href="#master">
                                <i class="fas fa-users"></i>
                                <p>Master</p>
                                <span class="caret"></span>
                            </a>
                            <div class="collapse" id="master">
                                <ul class="nav nav-collapse">
                                    <li>
                                        <a href="/userroleslist">
                                            <span class="sub-item">User roles</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="/users">
                                            <span class="sub-item">Users</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a href="/shifts">
                                <i class="fa-solid fa-clock"></i>
                                <p>Shifts</p>
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a href="/shiftLogs">
                                <i class="fas fa-clipboard-list"></i>
                                <p>Shift Logs</p>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="main-panel">
            <div class="main-header">
                <div class="main-header-logo">
                    <div class="logo-header" data-background-color="dark">
                        <a href="/index" class="logo">
                            <img src="/img/kaiadmin/logo_light.svg" alt="navbar brand" class="navbar-brand" height="20">
                        </a>
                        <div class="nav-toggle">
                            <button class="btn btn-toggle toggle-sidebar">
                                <i class="gg-menu-right"></i>
                            </button>
                            <button class="btn btn-toggle sidenav-toggler">
                                <i class="gg-menu-left"></i>
                            </button>
                        </div>
                        <button class="topbar-toggler more">
                            <i class="gg-more-vertical-alt"></i>
                        </button>
                    </div>
                </div>
                <!-- Navbar -->
                <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
  <div class="container-fluid justify-content-end">
    <a class="btn btn-danger" href="/login">Logout</a>
  </div>
</nav>

            </div>
            <div class="container">
                <div class="page-inner">
                    <div class="page-header">
                        <h3 class="fw-bold mb-3">Shift Logs</h3>
                        <ul class="breadcrumbs mb-3">
                            <li class="nav-home">
                                <a href="/index"><i class="icon-home"></i></a>
                            </li>
                            <li class="separator"><i class="icon-arrow-right"></i></li>
                            <li class="nav-item"><a href="/shiftLogs">Shift Logs</a></li>
                        </ul>
                    </div>
                    <div class="col-md-12">
                        <div class="card" style="background-color: rgb(221, 212, 212);">
                            <div class="card-header">
                                <div class="d-flex align-items-center">
                                    <h4 class="card-title">Shift Logs</h4>
                                    <div class="ms-auto">
                                        <button type="button" class="btn btn-primary btn-round" id="downloadCsv">
                                            <i class="fa fa-download"></i> Download Excel
                                        </button>
                                        <button type="button" class="btn btn-primary btn-round" id="downloadPdf">
                                            <i class="fa fa-download"></i> Download Pdf
                                        </button>
                                        <button class="btn btn-primary btn-round" data-bs-toggle="modal"
                                            data-bs-target="#assignShiftModal">
                                            <i class="fa fa-plus"></i> Assign Employee to Shift
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="modal fade" id="assignShiftModal" tabindex="-1" aria-hidden="true"
                                    data-bs-backdrop="static" data-bs-keyboard="false">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content p-3">
                                            <div class="modal-header border-0">
                                                <h5 class="modal-title">Assign Shift</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="assignShiftForm">
                                                    <div class="mb-3">
                                                        <label for="roleSelect" class="form-label">Role:</label>
                                                        <select id="roleSelect" class="form-select" name="role"
                                                            style="border: 1px solid black; padding: 10px;">
                                                            <option selected disabled>Select Role</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="employeeSelect" class="form-label">Employee:</label>
                                                        <select id="employeeSelect" class="form-select" name="userId"
                                                            style="border: 1px solid black; padding: 10px;">
                                                            <option selected disabled style="border: 1px solid black; padding: 10px;">
                                                                Select Employee</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Shifts:</label>
                                                        <div class="d-flex justify-content-between gap-2 flex-wrap"
                                                            id="shiftButtons">
                                                            <!-- Shift buttons will be dynamically inserted here -->
                                                        </div>
                                                        <input type="hidden" name="selectedShiftId" id="selectedShiftId"
                                                            required>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer border-0">
                                                <button type="submit" form="assignShiftForm"
                                                    class="btn btn-primary">Assign</button>
                                                <button type="button" class="btn btn-danger"
                                                    data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- edit modal -->
                                <div class="modal fade" id="editShiftLogModal" tabindex="-1" aria-hidden="true"
                                    data-bs-backdrop="static" data-bs-keyboard="false">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header border-0">
                                                <h5 class="modal-title">Edit Shift Log</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="editShiftLogForm">
                                                    <input type="hidden" id="editShiftLogId">
                                                    <div class="row">
                                                        <div class="col-sm-12">
                                                            <div class="form-group ">
                                                                <label>Role:</label>
                                                                <select id="editRole" class="form-control" required
                                                                    style="border: 1px solid black; padding: 10px;">
                                                                    <option value="">
                                                                        Select Role</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-12">
                                                            <div class="form-group ">
                                                                <label>Employee:</label>
                                                                <select id="editUserId" class="form-control" required
                                                                    style="border: 1px solid black; padding: 10px;">
                                                                    <option value="">Select Employee</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-12">
                                                            <div class="form-group">
                                                                <label>Shift:</label>
                                                                <select id="editShiftId" class="form-control" required
                                                                    style="border: 1px solid black; padding: 10px;">
                                                                    <option value="">Select Shift</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer border-0">
                                                <button type="submit" form="editShiftLogForm"
                                                    class="btn btn-primary">Save</button>
                                                <button type="button" class="btn btn-danger"
                                                    data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table id="shiftLogsTable" class="display table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Role</th>
                                                <th>Employee Name</th>
                                                <th>Shift Name</th>
                                                <th style="width: 10%">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize DataTable for shift logs
            const table = $('#shiftLogsTable').DataTable({
                ajax: {
                    url: '/api/shiftLogs',
                    dataSrc: 'data',
                    xhrFields: { withCredentials: true },
                    error: function (xhr, error, thrown) {
                        console.error('DataTables AJAX error:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error,
                            thrown: thrown,
                        });
                        alert('Failed to load shift logs. Check the console for details.');
                    },
                },
                columns: [
                    { data: 'id' },
                    { data: 'User.role' },
                    { data: 'User.firstName', render: (data, type, row) => `${data} ${row.User.lastName}` },
                    { data: 'Shift.name' },
                    {
                        data: null,
                        render: function (data, type, row) {
                            return `
            <div class="form-button-action">
              <button class="btn btn-primary btn-link edit-btn" data-id="${row.id}"><i class="fa fa-edit"></i></button>
              <button class="btn btn-danger btn-link delete-btn" data-id="${row.id}"><i class="fa fa-trash"></i></button>
            </div>`;
                        },
                    },
                ],
            });

            // Download CSV
            $('#downloadCsv').on('click', function (e) {
                e.preventDefault();
                const data = table.data().toArray();
                const csvRows = [
                    ['ID', 'Role', 'Employee Name', 'Shift Name'].join(','),
                    ...data.map(row => [
                        row.id,
                        `"${row.User.role}"`,
                        `"${row.User.firstName} ${row.User.lastName}"`,
                        `"${row.Shift.name.replace(/"/g, '""')}"`,
                    ].join(','))
                ];
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', 'Shift_Logs.csv');
                a.click();
                window.URL.revokeObjectURL(url);
            });

            // Download PDF
            $('#downloadPdf').on('click', function (e) {
                e.preventDefault();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(16);
                doc.text('Shift Logs', 10, 10);
                doc.setFontSize(12);
                const data = table.data().toArray();
                let y = 20;
                doc.text(['ID', 'Role', 'Employee Name', 'Shift Name'].join('  |  '), 10, y);
                y += 10;
                doc.line(10, y - 5, 200, y - 5);
                data.forEach(row => {
                    doc.text([
                        row.id,
                        row.User.role,
                        `${row.User.firstName} ${row.User.lastName}`,
                        row.Shift.name,
                    ].join('  |  '), 10, y);
                    y += 10;
                });
                doc.save('Shift_Logs.pdf');
            });

            // Assign Shift Modal - Populate roles, employees, and shifts dynamically
            $('#assignShiftModal').on('shown.bs.modal', function () {
                // Reset form and clear previous selections
                $('#assignShiftForm')[0].reset();
                $('#selectedShiftId').val('');
                $('#shiftButtons').empty(); // Clear existing shift buttons

                // Fetch roles and employees
                $('#roleSelect').find('option:not(:first)').remove();
                $('#employeeSelect').find('option:not(:first)').remove();
                $.get('/api/user', function (response) {
                    if (response.success && response.data.length > 0) {
                        const roles = [...new Set(response.data.map(user => user.role))];
                        roles.forEach(role => {
                            $('#roleSelect').append(`<option value="${role}">${role}</option>`);
                        });
                        response.data.forEach(user => {
                            $('#employeeSelect').append(`<option value="${user.id}" data-role="${user.role}">${user.firstName} ${user.lastName}</option>`);
                        });
                    } else {
                        $('#employeeSelect').append(`<option value="">No employees available</option>`);
                        $('#roleSelect').append(`<option value="">No roles available</option>`);
                    }
                }).fail(function (xhr, status, error) {
                    console.error('Error fetching users:', status, error);
                    $('#employeeSelect').append(`<option value="">Error loading employees</option>`);
                    $('#roleSelect').append(`<option value="">Error loading roles</option>`);
                });

                // Fetch shifts and generate buttons dynamically
                $.get('/api/shifts', function (response) {
                    $('#shiftButtons').empty();   // remove duplicate buttons
                    if (response.success && response.data.length > 0) {
                        response.data.forEach(shift => {
                            const buttonHtml = `<button type="button" class="btn btn-outline-primary flex-fill shift-btn" data-id="${shift.id}">${shift.name}<br><small>${shift.startTime} - ${shift.endTime}</small></button>`;
                            $('#shiftButtons').append(buttonHtml);
                        });
                    } else {
                        $('#shiftButtons').append('<p>No shifts available</p>');
                    }
                }).fail(function (xhr, status, error) {
                    console.error('Error fetching shifts:', status, error);
                    $('#shiftButtons').append('<p>Error loading shifts</p>');
                });

                // Filter employees based on selected role
                $('#roleSelect').on('change', function () {
                    const selectedRole = $(this).val();
                    $('#employeeSelect option').each(function () {
                        const employeeRole = $(this).data('role');
                        if (selectedRole && employeeRole !== selectedRole && $(this).val() !== '') {
                            $(this).hide();
                        } else {
                            $(this).show();
                        }
                    });
                    $('#employeeSelect').val(''); // Reset employee selection
                });

                // Delegate click event for dynamically created shift buttons
                $('#shiftButtons').on('click', '.shift-btn', function () {
                    $('.shift-btn').removeClass('active');
                    $(this).addClass('active');
                    $('#selectedShiftId').val($(this).data('id'));
                });
            });

            // Edit Shift Log Modal - Populate roles, employees, and shifts
            $('#editShiftLogModal').on('shown.bs.modal', function () {
                $('#editRole').find('option:not(:first)').remove();
                $('#editUserId').find('option:not(:first)').remove();
                $('#editShiftId').find('option:not(:first)').remove();
                $.get('/api/user', function (response) {
                    if (response.success && response.data.length > 0) {
                        const roles = [...new Set(response.data.map(user => user.role))];
                        roles.forEach(role => {
                            $('#editRole').append(`<option value="${role}">${role}</option>`);
                        });
                        response.data.forEach(user => {
                            $('#editUserId').append(`<option value="${user.id}" data-role="${user.role}">${user.firstName} ${user.lastName}</option>`);
                        });
                    } else {
                        $('#editUserId').append(`<option value="">No employees available</option>`);
                        $('#editRole').append(`<option value="">No roles available</option>`);
                    }
                }).fail(function (xhr, status, error) {
                    console.error('Error fetching users:', status, error);
                    $('#editUserId').append(`<option value="">Error loading employees</option>`);
                    $('#editRole').append(`<option value="">Error loading roles</option>`);
                });
                $.get('/api/shifts', function (response) {
                    if (response.success && response.data.length > 0) {
                        response.data.forEach(shift => {
                            $('#editShiftId').append(`<option value="${shift.id}">${shift.name}</option>`);
                        });
                    } else {
                        $('#editShiftId').append(`<option value="">No shifts available</option>`);
                    }
                }).fail(function (xhr, status, error) {
                    console.error('Error fetching shifts:', status, error);
                    $('#editShiftId').append(`<option value="">Error loading shifts</option>`);
                });

                // Filter employees based on selected role
                $('#editRole').on('change', function () {
                    const selectedRole = $(this).val();
                    $('#editUserId option').each(function () {
                        const employeeRole = $(this).data('role');
                        if (selectedRole && employeeRole !== selectedRole && $(this).val() !== '') {
                            $(this).hide();
                        } else {
                            $(this).show();
                        }
                    });
                    $('#editUserId').val(''); // Reset employee selection
                });
            });

            // Assign Shift Form Submission
            $('#assignShiftForm').on('submit', function (e) {
                e.preventDefault();
                const userId = $('#employeeSelect').val();
                const shiftId = $('#selectedShiftId').val();
                const role = $('#roleSelect').val();
                if (!userId || !shiftId || !role) {
                    alert('Please select role, employee, and shift.');
                    return;
                }
                $.ajax({
                    url: '/api/shiftLogs',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ userId, shiftId, role }),
                    xhrFields: { withCredentials: true },
                    success: function (response) {
                        if (response.success) {
                            table.ajax.reload();
                            $('#assignShiftModal').modal('hide');
                            $('#assignShiftForm')[0].reset();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (xhr) {
                        console.error('Assign shift error:', xhr.responseJSON);
                        alert('Error assigning shift: ' + (xhr.responseJSON?.message || 'Unknown error'));
                    },
                });
            });

            // Edit Shift Log - Fetch data
            $('#shiftLogsTable').on('click', '.edit-btn', function () {
                const id = $(this).data('id');
                $.ajax({
                    url: `/api/shiftLogs/${id}`,
                    method: 'GET',
                    xhrFields: { withCredentials: true },
                    success: function (response) {
                        if (response.success) {
                            const shiftLog = response.data;
                            $('#editShiftLogId').val(shiftLog.id);
                            $('#editRole').val(shiftLog.User.role);
                            $('#editUserId').val(shiftLog.userId);
                            $('#editShiftId').val(shiftLog.shiftId);
                            $('#editShiftLogModal').modal('show');
                        }
                    },
                    error: function (xhr) {
                        console.error('Fetch shift log error:', xhr.responseJSON);
                        alert('Error fetching shift log: ' + (xhr.responseJSON?.message || 'Unknown error'));
                    },
                });
            });

            // Edit Shift Log Form Submission
            $('#editShiftLogForm').on('submit', function (e) {
                e.preventDefault();
                const id = $('#editShiftLogId').val();
                const userId = $('#editUserId').val();
                const shiftId = $('#editShiftId').val();
                const role = $('#editRole').val();
                if (!userId || !shiftId || !role) {
                    alert('Please select role, employee, and shift.');
                    return;
                }
                $.ajax({
                    url: `/api/shiftLogs/${id}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ userId, shiftId, role }),
                    xhrFields: { withCredentials: true },
                    success: function (response) {
                        if (response.success) {
                            table.ajax.reload();
                            $('#editShiftLogModal').modal('hide');
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (xhr) {
                        console.error('Update shift log error:', xhr.responseJSON);
                        alert('Error updating shift log: ' + (xhr.responseJSON?.message || 'Unknown error'));
                    },
                });
            });

            // Delete Shift Log
            $('#shiftLogsTable').on('click', '.delete-btn', function () {
                const id = $(this).data('id');
                if (confirm('Are you sure you want to delete this shift log?')) {
                    $.ajax({
                        url: `/api/shiftLogs/${id}`,
                        method: 'DELETE',
                        xhrFields: { withCredentials: true },
                        success: function (response) {
                            if (response.success) {
                                table.ajax.reload();
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function (xhr) {
                            console.error('Delete shift log error:', xhr.responseJSON);
                            alert('Error deleting shift log: ' + (xhr.responseJSON?.message || 'Unknown error'));
                        },
                    });
                }
            });

            // Reset modals on close
            $('#assignShiftModal, #editShiftLogModal').on('hidden.bs.modal', function () {
                $('#assignShiftForm')[0].reset();
                $('#editShiftLogForm')[0].reset();
                $('.shift-btn').removeClass('active');
                $('#selectedShiftId').val('');
                $('#employeeSelect option').show();
                $('#editUserId option').show();
            });
        });

    </script>
</body>

</html>