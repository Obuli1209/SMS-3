<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/css/kaiadmin.min.css">
    <link rel="icon" href="/img/kaiadmin/favicon.ico" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .shift-btn {
            min-width: 120px;
            text-align: center;
            padding: 10px;
            margin: 5px;
            border-radius: 8px;
            border: 1px solid #0d6efd;
            background-color: #f8f9fa;
        }

        .shift-btn.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .shift-btn:hover {
            background-color: #0d6efd;
            color: white;
        }

        .select2-container--default .select2-selection--multiple {
            border: 1px solid black;
            padding: 10px;
            min-height: 44px;
        }

        .select2-container--default .select2-selection--single {
            border: 1px solid black;
            padding: 10px;
            height: 44px;
            display: flex;
            align-items: center;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 44px;
        }
    </style>
    <script src="/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: { families: ["Public Sans:300,400,500,600,700"] },
            custom: {
                families: [
                    "Font Awesome 5 Solid",
                    "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands",
                    "simple-line-icons",
                ],
                urls: ["/css/fonts.min.css"],
            },
            active: function () {
                sessionStorage.fonts = true;
            },
        });
    </script>
</head>

<body style="background-color: rgb(197, 197, 197);">
    <div class="wrapper">
        <div class="sidebar" data-background-color="dark">
            <div class="sidebar-logo">
                <div class="logo-header" data-background-color="dark">
                    <h4 style="color: white; padding-left: 10px;">SMS</h4>
                    <div class="nav-toggle">
                        <button class="btn btn-toggle toggle-sidebar">
                            <i class="gg-menu-right"></i>
                        </button>
                        <button class="btn btn-toggle sidenav-toggler">
                            <i class="gg-menu-left"></i>
                        </button>
                    </div>
                    <button class="topbar-toggler more">
                        <i class="gg-more-vertical-alt"></i>
                    </button>
                </div>
            </div>
            <div class="sidebar-wrapper scrollbar scrollbar-inner">
                <div class="sidebar-content">
                    <ul class="nav nav-secondary">
                        <li class="nav-item">
                            <a href="/index" class="nav-link">
                                <i class="fas fa-home"></i>
                                <p>Dashboard</p>
                            </a>
                        </li>
                        <li class="nav-section">
                            <span class="sidebar-mini-icon">
                                <i class="fa fa-ellipsis-h"></i>
                            </span>
                            <h4 class="text-section">Components</h4>
                        </li>
                        <li class="nav-item">
                            <a data-bs-toggle="collapse" href="#master">
                                <i class="fas fa-users"></i>
                                <p>Master</p>
                                <span class="caret"></span>
                            </a>
                            <div class="collapse" id="master">
                                <ul class="nav nav-collapse">
                                    <li>
                                        <a href="/userroleslist">
                                            <span class="sub-item">User roles</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="/users">
                                            <span class="sub-item">Users</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a href="/shifts">
                                <i class="fa-solid fa-clock"></i>
                                <p>Shifts</p>
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a href="/shiftLogs">
                                <i class="fas fa-clipboard-list"></i>
                                <p>Shift Logs</p>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="main-panel">
            <div class="main-header">
                <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
                    <div class="container-fluid justify-content-end">
                        <a class="btn btn-danger" href="/login" style="margin-right: 50px;">Logout</a>
                    </div>
                </nav>
            </div>
            <div class="container">
                <div class="page-inner">
                    <div class="page-header">
                        <h3 class="fw-bold mb-3">Shift Logs</h3>
                        <ul class="breadcrumbs mb-3">
                            <li class="nav-home">
                                <a href="/index"><i class="icon-home"></i></a>
                            </li>
                            <li class="separator"><i class="icon-arrow-right"></i></li>
                            <li class="nav-item"><a href="/shiftLogs">Shift Logs</a></li>
                        </ul>
                    </div>
                    <div class="col-md-12">
                        <div class="card" style="background-color: rgb(221, 212, 212);">
                            <div class="card-header">
                                <div class="d-flex align-items-center">
                                    <h4 class="card-title">Shift Logs</h4>
                                    <div class="ms-auto">
                                        <button type="button" class="btn btn-primary btn-round" id="downloadCsv">
                                            <i class="fa fa-download"></i> Download Excel
                                        </button>
                                        <button type="button" class="btn btn-primary btn-round" id="downloadPdf">
                                            <i class="fa fa-download"></i> Download Pdf
                                        </button>
                                        <button class="btn btn-primary btn-round" data-bs-toggle="modal"
                                            data-bs-target="#assignShiftModal">
                                            <i class="fa fa-plus"></i> Assign Employee to Shift
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Add shift assignment modal -->
                                <div class="modal fade" id="assignShiftModal" tabindex="-1" aria-hidden="true"
                                    data-bs-backdrop="static" data-bs-keyboard="false">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content p-3">
                                            <div class="modal-header border-0">
                                                <h5 class="modal-title">Assign Shift</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="assignShiftForm">
                                                    <div class="mb-3">
                                                        <label for="roleSelect" class="form-label">Role:</label>
                                                        <select id="roleSelect" class="form-select" name="role"
                                                            style="border: 1px solid black; padding: 10px;" required>
                                                            <option value="" selected disabled>Select Role</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="employeeSelect" class="form-label">Employee:</label>
                                                        <select id="employeeSelect" class="form-select" name="userIds[]"
                                                            multiple style="border: 1px solid black; padding: 10px;"
                                                            required>
                                                            <!-- <option value="" disabled></option> -->
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Shift:</label>
                                                        <div id="shiftButtons" class="d-flex flex-wrap"></div>
                                                        <input type="hidden" id="shiftSelect" name="shiftId" required>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer border-0">
                                                <button type="submit" form="assignShiftForm"
                                                    class="btn btn-primary">Assign</button>
                                                <button type="button" class="btn btn-danger"
                                                    data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Edit shift log modal -->
                                <div class="modal fade" id="editShiftLogModal" tabindex="-1" aria-hidden="true"
                                    data-bs-backdrop="static" data-bs-keyboard="false">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header border-0">
                                                <h5 class="modal-title">Edit Shift Log</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="editShiftLogForm">
                                                    <input type="hidden" id="editShiftLogId">
                                                    <div class="row">
                                                        <div class="col-sm-12">
                                                            <div class="form-group">
                                                                <label>Role:</label>
                                                                <select id="editRole" class="form-control" required
                                                                    style="border: 1px solid black; padding: 10px;">
                                                                    <option value="" selected disabled>Select Role
                                                                    </option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-12">
                                                            <div class="form-group">
                                                                <label>Employee:</label>
                                                                <select id="editUserId" class="form-control" required
                                                                    style="border: 1px solid black; padding: 10px;">
                                                                    <option value="" selected disabled>Select Employee
                                                                    </option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-12">
                                                            <div class="form-group">
                                                                <label>Shift:</label>
                                                                <div id="editShiftButtons" class="d-flex flex-wrap">
                                                                </div>
                                                                <input type="hidden" id="editShiftId" name="shiftId"
                                                                    required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer border-0">
                                                <button type="submit" form="editShiftLogForm"
                                                    class="btn btn-primary">Save</button>
                                                <button type="button" class="btn btn-danger"
                                                    data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- <div class="card-body p-2">
                                <div class="table-responsive p-0">
                                    <table id="shiftLogsTable" 
                                        class="table table-sm table-bordered table-striped table-hover text-nowrap small w-100"
                                        style="table-layout: fixed;">
                                        <thead>
                                            <tr>
                                                <th style="width: 20%">ID</th>
                                                <th style="width: 20%">Role</th>
                                                <th style="width: 20%">Employee Name</th>
                                                <th style="width: 20%">Shift Name</th>
                                                <th style="width: 20%">Action</th>
                                            </tr>
                                        </thead>
                                    </table>
                                </div>
                            </div> -->
                                <div class="card-body p-2">
                                    <div class="table-responsive p-0">
                                        <table id="shiftLogsTable"
                                            class="table table-sm table-bordered table-striped table-hover text-nowrap small w-100"
                                            style="table-layout: fixed;">
                                            <thead>
                                                <tr>
                                                    <th class="text-center align-middle" style="width: 20%;">ID</th>
                                                    <th class="text-center align-middle" style="width: 20%;">Role</th>
                                                    <th class="text-center align-middle" style="width: 20%;">Employee
                                                        Name</th>
                                                    <th class="text-center align-middle" style="width: 20%;">Shift Name
                                                    </th>
                                                    <th class="text-center align-middle" style="width: 20%;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody class="text-center align-middle">
                                                <!-- Table rows will be added here dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

        <script>
            $(document).ready(function () {
                // Initialize Select2 for employee selects
                $('#employeeSelect').select2({
                    placeholder: 'Select Employees',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#assignShiftModal')
                });

                $('#editUserId').select2({
                    placeholder: 'Select Employee',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#editShiftLogModal')
                });

                // Initialize DataTable for shift logs
                const table = $('#shiftLogsTable').DataTable({
                    ajax: {
                        url: '/api/shiftLogs',
                        dataSrc: 'data',
                        xhrFields: { withCredentials: true },
                        error: function (xhr, error, thrown) {
                            console.error('DataTables AJAX error:', {
                                status: xhr.status,
                                statusText: xhr.statusText,
                                responseText: xhr.responseText,
                                error: error,
                                thrown: thrown,
                            });
                            alert('Failed to load shift logs. Check the console for details.');
                        },
                    },
                    columns: [
                        { data: 'id' },
                        { data: 'User.role' },
                        { data: 'User.firstName', render: (data, type, row) => `${data} ${row.User.lastName}` },
                        { data: 'Shift.name' },
                        {
                            data: null,
                            render: function (data, type, row) {
                                return `
                                <div class="form-button-action">
                                    <button class="btn btn-primary btn-link edit-btn" data-id="${row.id}"><i class="fa fa-edit"></i></button>
                                    <button class="btn btn-danger btn-link delete-btn" data-id="${row.id}"><i class="fa fa-trash"></i></button>
                                </div>`;
                            },
                        },
                    ],
                });

                // CSV Download
                $('#downloadCsv').on('click', function (e) {
                    e.preventDefault();
                    const data = table.data().toArray();

                    function escapeCsvValue(value) {
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }

                    const csvRows = [
                        ['ID', 'Role', 'Employee Name', 'Shift Name'].join(','),
                        ...data.map(row => [
                            escapeCsvValue(row.id),
                            escapeCsvValue(row.User?.role || ''),
                            escapeCsvValue(`${row.User?.firstName || ''} ${row.User?.lastName || ''}`.trim()),
                            escapeCsvValue(row.Shift?.name || ''),
                        ].join(',')),
                    ];

                    const csvString = csvRows.join('\n');
                    const blob = new Blob([csvString], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Shift_Logs.csv';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    }, 100);
                });

                // PDF Download
                $('#downloadPdf').on('click', function (e) {
                    e.preventDefault();

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    doc.setFontSize(16);
                    doc.text('Shift Logs', 10, 10);
                    doc.setFontSize(12);

                    const data = table.data().toArray();
                    let y = 20;

                    doc.text('ID  |  Role  |  Employee Name  |  Shift Name', 10, y);
                    y += 10;
                    doc.line(10, y - 5, 200, y - 5);

                    data.forEach(row => {
                        if (y > 280) {
                            doc.addPage();
                            y = 20;
                            doc.text('ID  |  Role  |  Employee Name  |  Shift Name', 10, y);
                            y += 10;
                            doc.line(10, y - 5, 200, y - 5);
                        }

                        const line = [
                            row.id,
                            row.User?.role || 'N/A',
                            `${row.User?.firstName || ''} ${row.User?.lastName || ''}`.trim(),
                            row.Shift?.name || ''
                        ].join('  |  ');

                        doc.text(line, 10, y);
                        y += 10;
                    });

                    doc.save('Shift_Logs.pdf');
                });

                // Flag to prevent duplicate API calls
                let isFetchingData = false;

                // Function to populate roles
                function populateRoles(selectElement, selectedRole = '') {
                    console.log('Fetching roles from /api/userroles/list');
                    $.get('/api/userroles/list', function (response) {
                        console.log('Roles response:', response);
                        selectElement.find('option:not(:first)').remove();
                        if (response && Array.isArray(response) && response.length > 0) {
                            response.forEach(role => {
                                const isSelected = role.roleName === selectedRole ? 'selected' : '';
                                selectElement.append(`<option value="${role.roleName}" ${isSelected}>${role.roleName}</option>`);
                            });
                        } else {
                            console.warn('No roles found or invalid response');
                            selectElement.append(`<option value="">No roles available</option>`);
                            selectElement.closest('form').find('button[type="submit"]').prop('disabled', true);
                        }
                    }).fail(function (xhr) {
                        console.error('Error fetching roles:', xhr.status, xhr.responseText);
                        selectElement.append(`<option value="">Error loading roles (Status: ${xhr.status})</option>`);
                        selectElement.closest('form').find('button[type="submit"]').prop('disabled', true);
                    });
                }

                // Function to populate shifts as buttons
                function populateShiftButtons(containerElement, hiddenInput, selectedShiftId = '') {
                    console.log('Fetching shifts from /api/shifts');
                    $.get('/api/shifts', function (response) {
                        console.log('Shifts response:', response);
                        containerElement.empty();
                        if (response.success && Array.isArray(response.data) && response.data.length > 0) {
                            response.data.forEach(shift => {
                                const isSelected = shift.id === selectedShiftId ? 'active' : '';
                                containerElement.append(`
                                <button type="button" class="shift-btn ${isSelected}" data-shift-id="${shift.id}">
                                    ${shift.name} (${shift.startTime} - ${shift.endTime})
                                </button>
                            `);
                            });
                            if (selectedShiftId) {
                                hiddenInput.val(selectedShiftId);
                            }
                        } else {
                            console.warn('No shifts found or invalid response');
                            containerElement.append(`<p>No shifts available</p>`);
                            hiddenInput.closest('form').find('button[type="submit"]').prop('disabled', true);
                        }
                    }).fail(function (xhr) {
                        console.error('Error fetching shifts:', xhr.status, xhr.responseText);
                        containerElement.append(`<p>Error loading shifts (Status: ${xhr.status})</p>`);
                        hiddenInput.closest('form').find('button[type="submit"]').prop('disabled', true);
                    });
                }

                // Function to populate users
                function populateUsers(selectElement, role, currentUserId = '') {
                    console.log('Fetching users for role:', role);
                    if (!role) {
                        selectElement.find('option:not(:first)').remove();
                        selectElement.append(`<option value="">Select a role first</option>`);
                        selectElement.closest('form').find('button[type="submit"]').prop('disabled', true);
                        selectElement.val(null).trigger('change');
                        return;
                    }
                    if (!isFetchingData) {
                        isFetchingData = true;
                        $.get(`/api/shiftlogs/usersbyrole?role=${encodeURIComponent(role)}`, function (response) {
                            console.log('Users by role response:', response);
                            selectElement.find('option:not(:first)').remove();
                            if (response && response.success && Array.isArray(response.data) && response.data.length > 0) {
                                response.data.forEach(user => {
                                    const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Unknown User';
                                    selectElement.append(`
                                    <option value="${user.id}" data-role="${user.role || ''}">
                                        ${fullName}
                                    </option>
                                `);
                                });
                                // Ensure no options are marked as selected in the HTML
                                selectElement.find('option').prop('selected', false);
                                // Only pre-select in edit modal if currentUserId is provided
                                if (selectElement.attr('id') === 'editUserId' && currentUserId) {
                                    selectElement.val(currentUserId).trigger('change');
                                } else {
                                    // Explicitly clear selection for assign modal
                                    selectElement.val(null).trigger('change');
                                }
                                selectElement.closest('form').find('button[type="submit"]').prop('disabled', false);
                            } else {
                                console.warn('No users found for role:', role, 'Response:', response);
                                selectElement.append(`<option value="">No employees found for this role</option>`);
                                selectElement.val(null).trigger('change');
                                selectElement.closest('form').find('button[type="submit"]').prop('disabled', true);
                            }
                        }).fail(function (xhr) {
                            console.error('Error fetching users for role:', role, 'Status:', xhr.status, 'Response:', xhr.responseText);
                            selectElement.append(`<option value="">Error loading employees (Status: ${xhr.status})</option>`);
                            selectElement.val(null).trigger('change');
                            selectElement.closest('form').find('button[type="submit"]').prop('disabled', true);
                        }).always(function () {
                            isFetchingData = false;
                        });
                    }
                }

                // Assign Shift Modal - Populate roles, employees, and shifts
                $('#assignShiftModal').on('shown.bs.modal', function () {
                    console.log('Assign Shift Modal opened');
                    $('#assignShiftForm')[0].reset();
                    $('#employeeSelect').find('option:not(:first)').remove();
                    $('#employeeSelect').val(null).trigger('change');
                    $('#shiftButtons').empty();
                    $('#shiftSelect').val('');
                    $('#assignShiftForm button[type="submit"]').prop('disabled', false);

                    populateRoles($('#roleSelect'));
                    populateShiftButtons($('#shiftButtons'), $('#shiftSelect'));

                    $('#roleSelect').off('change').on('change', function () {
                        const role = $(this).val();
                        console.log('Role selected:', role);
                        $('#employeeSelect').find('option:not(:first)').remove(); // Clear previous options
                        $('#employeeSelect').val(null).trigger('change'); // Reset Select2
                        populateUsers($('#employeeSelect'), role); // No currentUserId for assign modal
                    });

                    $('#shiftButtons').off('click').on('click', '.shift-btn', function () {
                        $('#shiftButtons .shift-btn').removeClass('active');
                        $(this).addClass('active');
                        const shiftId = $(this).data('shift-id');
                        console.log('Shift selected:', shiftId);
                        $('#shiftSelect').val(shiftId);
                    });
                });

                // Edit Shift Log Modal - Populate roles, employees, and shifts
                $('#editShiftLogModal').on('shown.bs.modal', function () {
                    console.log('Edit Shift Log Modal opened');
                    $('#editShiftLogForm')[0].reset();
                    $('#editUserId').find('option:not(:first)').remove();
                    $('#editUserId').val(null).trigger('change');
                    $('#editShiftButtons').empty();
                    $('#editShiftId').val('');
                    $('#editShiftLogForm button[type="submit"]').prop('disabled', false);

                    populateRoles($('#editRole'), $('#editRole').val());
                    populateShiftButtons($('#editShiftButtons'), $('#editShiftId'), $('#editShiftId').val());

                    $('#editRole').off('change').on('change', function () {
                        const role = $(this).val();
                        console.log('Edit role selected:', role);
                        const currentUserId = $('#editUserId').data('current-user-id') || '';
                        $('#editUserId').find('option:not(:first)').remove(); // Clear previous options
                        $('#editUserId').val(null).trigger('change'); // Reset Select2
                        populateUsers($('#editUserId'), role, currentUserId);
                    });

                    $('#editShiftButtons').off('click').on('click', '.shift-btn', function () {
                        $('#editShiftButtons .shift-btn').removeClass('active');
                        $(this).addClass('active');
                        const shiftId = $(this).data('shift-id');
                        console.log('Edit shift selected:', shiftId);
                        $('#editShiftId').val(shiftId);
                    });
                });

                // Assign Shift Form Submission
                $('#assignShiftForm').on('submit', function (e) {
                    e.preventDefault();

                    const shiftId = parseInt($('#shiftSelect').val());
                    const userIds = $('#employeeSelect').val().map(id => parseInt(id));

                    if (!shiftId || userIds.length === 0) {
                        alert('Please select a shift and at least one employee.');
                        return;
                    }

                    $.ajax({
                        type: 'POST',
                        url: '/api/shiftlogs',
                        contentType: 'application/json',
                        data: JSON.stringify({ shiftId, userIds }),
                        success: function (response) {
                            $('#assignShiftModal').modal('hide');
                            $('#shiftLogsTable').DataTable().ajax.reload();
                            alert('Shifts assigned successfully!');
                        },
                        error: function (xhr) {
                            console.error(xhr.responseText);
                            alert('Selected users already have shift assignments.');
                        }
                    });
                });

                // Edit Shift Log - Fetch data
                $('#shiftLogsTable').on('click', '.edit-btn', function () {
                    const id = $(this).data('id');
                    console.log('Fetching shift log:', id);
                    $.ajax({
                        url: `/api/shiftLogs/${id}`,
                        method: 'GET',
                        xhrFields: { withCredentials: true },
                        success: function (response) {
                            console.log('Shift log fetched:', response);
                            if (response.success) {
                                const shiftLog = response.data;
                                $('#editShiftLogId').val(shiftLog.id);
                                $('#editRole').val(shiftLog.User.role);
                                $('#editUserId').data('current-user-id', shiftLog.userId);
                                $('#editShiftId').val(shiftLog.shiftId);
                                $('#editShiftLogModal').modal('show');
                                $('#editRole').trigger('change');
                                populateShiftButtons($('#editShiftButtons'), $('#editShiftId'), shiftLog.shiftId);
                            }
                        },
                        error: function (xhr) {
                            console.error('Fetch shift log error:', xhr.status, xhr.responseText);
                            alert('Error fetching shift log: ' + (xhr.responseJSON?.message || 'Unknown error'));
                        },
                    });
                });

                // Edit Shift Log Form Submission
                $('#editShiftLogForm').on('submit', function (e) {
                    e.preventDefault();
                    const id = $('#editShiftLogId').val();
                    const userId = $('#editUserId').val();
                    const shiftId = $('#editShiftId').val();
                    const role = $('#editRole').val();
                    const selectedEmployeeRole = $('#editUserId option:selected').data('role');
                    console.log('Edit Shift Log Form submitted:', { id, userId, shiftId, role, selectedEmployeeRole });
                    if (!userId || !shiftId || !role) {
                        alert('Please select role, employee, and shift.');
                        return;
                    }
                    if (role !== selectedEmployeeRole) {
                        alert('Selected role does not match employee role.');
                        return;
                    }
                    $.ajax({
                        url: `/api/shiftLogs/${id}`,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify({ userId, shiftId, role }),
                        xhrFields: { withCredentials: true },
                        success: function (response) {
                            console.log('Update shift log success:', response);
                            if (response.success) {
                                table.ajax.reload();
                                $('#editShiftLogModal').modal('hide');
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function (xhr) {
                            console.error('Update shift log error:', xhr.status, xhr.responseText);
                            alert('Error updating shift log: ' + (xhr.responseJSON?.message || 'Unknown error'));
                        },
                    });
                });

                // Delete Shift Log
                $('#shiftLogsTable').on('click', '.delete-btn', function () {
                    const id = $(this).data('id');
                    console.log('Deleting shift log:', id);
                    if (confirm('Are you sure you want to delete this shift log?')) {
                        $.ajax({
                            url: `/api/shiftLogs/${id}`,
                            method: 'DELETE',
                            xhrFields: { withCredentials: true },
                            success: function (response) {
                                console.log('Delete shift log success:', response);
                                if (response.success) {
                                    table.ajax.reload();
                                } else {
                                    alert(response.message);
                                }
                            },
                            error: function (xhr) {
                                console.error('Delete shift log error:', xhr.status, xhr.responseText);
                                alert('Error deleting shift log: ' + (xhr.responseJSON?.message || 'Unknown error'));
                            },
                        });
                    }
                });

                // Reset modals on close
                $('#assignShiftModal, #editShiftLogModal').on('hidden.bs.modal', function () {
                    console.log('Modal closed');
                    $('#assignShiftForm')[0].reset();
                    $('#editShiftLogForm')[0].reset();
                    $('#employeeSelect').find('option:not(:first)').remove();
                    $('#editUserId').find('option:not(:first)').remove();
                    $('#employeeSelect').val(null).trigger('change');
                    $('#editUserId').val(null).trigger('change');
                    $('#shiftButtons').empty();
                    $('#editShiftButtons').empty();
                    $('#shiftSelect').val('');
                    $('#editShiftId').val('');
                    $('#assignShiftForm button[type="submit"]').prop('disabled', false);
                    $('#editShiftLogForm button[type="submit"]').prop('disabled', false);
                });
            });
        </script>
</body>

</html>